<div class="rain-background" id="rainBackground"></div>

<script is:inline>
class RainManager {
    constructor(rainBackgroundId = 'rainBackground') {
        this.rainBackground = document.getElementById(rainBackgroundId);
        if (!this.rainBackground) {
            console.error('Rain background element not found');
            return;
        }
        this.lastDropTime = 0;
        this.dropInterval = 25;
        this.dropsPerInterval = 3;
        this.animationId = null;
        this.isRunning = false;
        this.dropPool = [];
        this.maxPoolSize = 50;
        this.init();
    }

    init() {
        this.startRain();
    }

    createDropElement() {
        const drop = document.createElement('div');
        drop.className = 'raindrop';
        return drop;
    }

    getDropFromPool() {
        if (this.dropPool.length > 0) {
            return this.dropPool.pop();
        }
        return this.createDropElement();
    }

    returnDropToPool(drop) {
        if (this.dropPool.length < this.maxPoolSize) {
            drop.style.transform = '';
            drop.style.opacity = '';
            this.dropPool.push(drop);
        }
    }

    spawnRaindrops() {
        const fragment = document.createDocumentFragment();

        for (let i = 0; i < this.dropsPerInterval; i++) {
            const raindrop = this.getDropFromPool();

            const left = Math.random() * 100;
            const height = 20 + Math.random() * 15;
            const duration = 0.6 + Math.random() * 0.4;
            const opacity = 0.15 + Math.random() * 0.25;
            const delay = Math.random() * 0.1;
            const angle = -2 + Math.random() * 4;

            raindrop.style.left = `${left}vw`;
            raindrop.style.height = `${height}px`;
            raindrop.style.opacity = opacity;
            raindrop.style.animationDuration = `${duration}s`;
            raindrop.style.animationDelay = `${delay}s`;
            raindrop.style.setProperty('--wind-angle', `${angle}deg`);

            fragment.appendChild(raindrop);

            setTimeout(() => {
                if (raindrop.parentNode) {
                    raindrop.parentNode.removeChild(raindrop);
                }
                this.returnDropToPool(raindrop);
            }, (duration + delay) * 1000);
        }

        this.rainBackground.appendChild(fragment);
    }

    rainLoop(timestamp) {
        if (!this.isRunning) return;

        if (!this.lastDropTime) this.lastDropTime = timestamp;
        const elapsed = timestamp - this.lastDropTime;

        if (elapsed > this.dropInterval) {
            this.spawnRaindrops();
            this.lastDropTime = timestamp - (elapsed % this.dropInterval);
        }

        this.animationId = requestAnimationFrame((ts) => this.rainLoop(ts));
    }

    startRain() {
        if (this.isRunning) return;

        this.isRunning = true;
        this.lastDropTime = 0;
        this.animationId = requestAnimationFrame((ts) => this.rainLoop(ts));
    }

    stopRain() {
        this.isRunning = false;
        if (this.animationId) {
            cancelAnimationFrame(this.animationId);
            this.animationId = null;
        }
    }

    handleVisibilityChange() {
        if (document.hidden) {
            this.stopRain();
        } else {
            this.startRain();
        }
    }
}

if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initRain);
} else {
    initRain();
}

function initRain() {
    const rainManager = new RainManager('rainBackground');

    document.addEventListener('visibilitychange', () => {
        rainManager.handleVisibilityChange();
    });
}
</script>